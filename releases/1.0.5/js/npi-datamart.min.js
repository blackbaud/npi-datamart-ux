!function(){"use strict";angular.module("npi-datamart.api",["npi-datamart.authentication"]).factory("BBDataMartAPI",["$q","$timeout","$http",function(a,b,c){var d=function(d){function e(){return v||(v=a(function(a,b){y.getApiRoot().then(function(c){y.getDataMartId().then(function(b){a({apiRoot:c,dataMartId:b})})["catch"](b)})["catch"](b)})),v}function f(){return a(function(a,b){w.ensureAuthenticated().then(function(){e().then(function(b){a(b)})["catch"](b)})["catch"](b)})}function g(b,e){return x[e]||(x[e]=a(function(a,f){function g(d){var e={identifierToUri:[d]};c.post(b.apiRoot+"/gdc/md/"+b.dataMartId+"/identifiers",e,{withCredentials:!0}).then(function(b){b.data&&b.data.identifiers&&b.data.identifiers[0]&&b.data.identifiers[0].uri?a(b.data.identifiers[0].uri):f()})["catch"](f)}d.translateObjectIdentifier?d.translateObjectIdentifier(e).then(function(a){g(a)})["catch"](f):g(e)})),x[e]}function h(b,d){return a(function(a,e){c.get(b.apiRoot+d,{withCredentials:!0}).then(function(b){b.data?a(b.data):e()})["catch"](e)})}function i(b,d,e){var f,g,h=null;return a(function(a,i){c.get(b.apiRoot+d+"?filter="+e,{withCredentials:!0}).then(function(b){if(b.data&&b.data.attributeElements&&b.data.attributeElements.elements){for(f=0;f<b.data.attributeElements.elements.length;f+=1)if(g=b.data.attributeElements.elements[f],g.title.toString()===e.toString()){h=g.uri;break}a(h)}a(null)})["catch"](i)})}function j(a){return d.translateAttributeName?d.translateAttributeName(a):a}function k(a){var b=null;return a&&(b=0===a.lastIndexOf("attr.",0)?a.replace("attr.","label."):"label."+a),b}function l(d,e,f){return a(function(a,g){c.get(d.apiRoot+e,{withCredentials:!0}).then(function(c){f||!c.data||c.data.xtab_data?a(c):b(function(){a(l(d,e,!1))},3e3)})["catch"](g)})}function m(b,d){return a(function(a,e){c.post(b.apiRoot+"/gdc/app/projects/"+b.dataMartId+"/execute",d,{withCredentials:!0}).then(function(c){c.data&&c.data.execResult&&c.data.execResult.dataResult?a(l(b,c.data.execResult.dataResult)):e()})["catch"](e)})}function n(b,c,d){var e,f,g={uri:d,constraint:{type:"list"}},h=[];return a(function(j){if(c.value){for(f=Array.isArray(c.value)?c.value:[c.value],e=0;e<f.length;e+=1)h.push(i(b,d+"/elements",f[e]));h.length>0?a.all(h).then(function(a){g.constraint.elements=a,j(g)}):j(null)}else j(null)})}function o(b,c){return a(function(e,f){function h(c){var d={};for(l=0;l<c.length;l+=1){if(i=c[l].attribute?k(j(c[l].attribute)):c[l].attributeDisplayForm,!i)throw new Error("Filter must have an attribute or attribute display form specified");m.push(g(b,i))}a.all(m).then(function(f){for(m=[],l=0;l<c.length;l+=1)c[l].value&&m.push(n(b,c[l],f[l]));m.length>0?a.all(m).then(function(a){a.length>0&&(d={filters:a}),e(d)}):e(null)})["catch"](f)}var i,l,m=[];c?d.translateFilters?d.translateFilters(c).then(h):h(c):e(null)})}function p(b,c,d){return a(function(e,f){a.all([g(b,c),o(b,d)]).then(function(a){var c={},d={},g=a[0],h=a[1];d.report=g,h&&(d.context=h),c.report_req=d,m(b,c).then(e)["catch"](f)})["catch"](f)})}function q(b,d){return a(function(a,e){function f(d){c.get(d,{withCredentials:!0}).then(function(c){c.data&&c.data.uri?f(b.apiRoot+c.data.uri):a(c)})["catch"](e)}c.post(b.apiRoot+"/gdc/app/projects/"+b.dataMartId+"/execute/raw",d,{withCredentials:!0}).then(function(c){c.data&&c.data.uri?f(b.apiRoot+c.data.uri):a(c)})["catch"](e)})}function r(a){var b,c=null;return a.data&&a.data.xtab_data&&a.data.xtab_data.data&&(b=a.data.xtab_data.data,b[0]&&b[0][0]&&(c=b[0][0])),c}function s(b,c){return a(function(a,d){g(b,c).then(function(c){h(b,c).then(function(c){c&&c.report&&c.report.content&&c.report.content.definitions?h(b,c.report.content.definitions.pop()).then(function(b){a(b)})["catch"](d):d()})["catch"](d)})["catch"](d)})}function t(b,c,d){return a(function(e,f){var h,i,j,k,l=[s(b,c),g(b,c)];d&&l.push(o(b,d)),a.all(l).then(function(a){k=a[0],k&&k.reportDefinition&&k.reportDefinition.content&&k.reportDefinition.content.grid&&k.reportDefinition.content.grid.metrics&&k.reportDefinition.content.grid.metrics[0]&&k.reportDefinition.content.grid.metrics[0].uri&&(j=k.reportDefinition.content.grid.metrics[0].uri,h=k.reportDefinition.content.grid.metrics[0].drillAcrossStepAttributeDF),i={reportUri:a[1],executionContext:{drillInto:{locators:[{metricLocator:{uri:j}}],target:h,targetType:"attributeDisplayForm"},filters:d&&a[2]?a[2].filters:null}},e(i)})["catch"](f)})}function u(b,c){return a(function(a,d){var e={report_req:{context:c.executionContext,report:c.reportUri}};q(b,e).then(function(b){var c,e=[];b.data?(c=b.data.replace(/"/g,"").split("\n"),c.shift(),angular.forEach(c,function(a){var b=a.split(",")[0];b&&e.push(b)}),a(e)):d()})["catch"](d)})}var v,w,x={},y=this;if(d=d||{},w=d.authentication,!w)throw"An option for authentication must be provided.  This should be a BBDataMartAuthentication used to authenticate with the data mart API.";if(!d.dataMartId&&!d.getDataMartId)throw"An option for dataMartId or getDataMartId must be provided";y.getDataMartId=function(){return a(function(a,b){d.dataMartId?a(d.dataMartId):d.getDataMartId().then(a)["catch"](b)})},y.getApiRoot=function(){return w.getDomain()},y.platformIsAvailable=function(){return a(function(a){y.getApiRoot().then(function(b){c.get(b+"/gdc/ping",{withCredentials:!0}).then(function(){a(!0)})["catch"](function(){a(!1)})})})},y.getObjectUriFromIdentifier=function(b){return a(function(a,c){f().then(function(d){g(d,b).then(a)["catch"](c)})["catch"](c)})},y.executeReport=function(b,c){return a(function(a,d){f().then(function(e){p(e,b,c).then(a)["catch"](d)})["catch"](d)})},y.getHeadlineReportData=function(b,c){return a(function(a,d){f().then(function(e){p(e,b,c).then(function(b){a(r(b))})["catch"](d)})["catch"](d)})},y.getHeadlineReportDrillContext=function(b,c){return a(function(a,d){f().then(function(e){t(e,b,c).then(a)["catch"](d)})["catch"](d)})},y.loadDrillInRecordIds=function(b){return a(function(a,c){f().then(function(d){u(d,b).then(a)["catch"](c)})["catch"](c)})},y.getLatestReportDefinition=function(b){return a(function(a,c){f().then(function(d){s(d,b).then(a)["catch"](c)})["catch"](c)})},y.getObjectDefinitionByUri=function(b){return a(function(a,c){f().then(function(d){h(d,b).then(a)["catch"](c)})["catch"](c)})},y.maintainAuthentication=function(a){return w.maintainAuthentication(a)}};return d}])}(),function(){"use strict";angular.module("npi-datamart.authentication",[]).factory("BBDataMartAuthentication",["$q","$http","$rootScope",function(a,b,c){var d=function(d){function e(){return a(function(a,b){d.ssoProvider?a(d.ssoProvider):d.getSSOProvider().then(a)["catch"](b)})}function f(b){return a(function(c,f){var g=[d.getSSOToken(),n.getDomain(),e()];a.all(g).then(function(a){var d,e,f,g;f=a[0],e=a[1],g=a[2],f&&g&&(d=e,d+="/gdc/account/customerlogin?sessionId=",d+=encodeURIComponent(f),d+="&serverURL=",d+=encodeURIComponent(g),d+="&targetURL=",d+=encodeURIComponent(b),c(d))})["catch"](f)})}function g(a){return a&&401===a.status}function h(){return a(function(a,c){n.getDomain().then(function(d){var e=d+"/gdc/account/token";b.get(e,{withCredentials:!0}).then(function(){a()})["catch"](c)})["catch"](c)})}function i(){return a(function(a,c){f("/gdc/account/token").then(function(d){b.get(d,{withCredentials:!0}).then(function(){a()})["catch"](function(){h().then(function(){a()})["catch"](c)})})["catch"](c)})}function j(){return a(function(a,b){h().then(function(){a()})["catch"](function(c){g(c)?i().then(function(){a()})["catch"](b):b(c)})})}var k,l,m=0,n=this;if(d=d||{},!d.domain&&!d.getDomain)throw"An option for domain or getDomain must be provided";if(!d.ssoProvider&&!d.getSSOProvider)throw"An option for ssoProvider or getSSOProvider must be provided";if(!d.getSSOToken)throw"An option for getSSOToken must be provided.  This should be a function returning a promise for an SSO token to be used to authenticate with the data mart API.";n.getDomain=function(){return a(function(a,b){d.domain?a(d.domain):d.getDomain().then(a)["catch"](b)})},n.ensureAuthenticated=function o(){return k||(k=a(function(a,b){var d;l?d=j():(l=!0,d=i()),d.then(function(){var b,d=(new Date).getTime()+48e4;b=setInterval(function(){(new Date).getTime()>d&&(clearInterval(b),k=null,m>0&&c.$apply(function(){o()}))},1e3),a()})["catch"](function(a){k=null,b(a)})})),k},n.maintainAuthentication=function(b){return m+=1,b.$on("$destroy",function(){m-=1}),a(function(a,b){n.ensureAuthenticated().then(function(){a()})["catch"](b)})}};return d}])}(),function(){"use strict";var a={dashboardStylist:{skin:{"body.white":{background:"#f3f3f4"},".yui3-c-textdashboardwidget-middleText .yui3-c-textdashboardwidget-ipe, .yui3-c-textdashboardwidget-middleText .yui3-c-textdashboardwidget-label":{"font-size":"22px",color:"#292a2b","font-family":"Oswald","font-weight":"100",height:"40px"},".yui3-c-textdashboardwidget-smallText .yui3-c-textdashboardwidget-ipe, .yui3-c-textdashboardwidget-smallText .yui3-c-textdashboardwidget-label":{"font-size":"14px",color:"#292a2b","font-weight":"600"},".yui3-c-onenumberreport .description":{"font-size":"13px !important","line-height":"normal",color:"#292a2b"},".yui3-c-onenumberreport .number":{"font-size":"26px !important","font-family":"Oswald","line-height":"normal",color:"#292a2b"},".yui3-c-tabfilteritem .filterItemTitle, .yui3-c-dashboardwidget-editMode .yui3-c-tabfilteritem .titleContainer input":{"text-transform":"none","font-size":"12px",color:"#292a2b"},body:{"font-family":"Open Sans"},text:{"font-family":"Open Sans"},".yui3-c-linedashboardwidget .lineContent":{background:"#e7eaec",left:"0px"}},extraFonts:{googlefonts:["Oswald","Open Sans"]}}};angular.module("npi-datamart.report",["npi-datamart.templates","npi-datamart.api","sky"]).constant("bbDataMartReportConfiguration",{api:null,linkHandler:null,drillHandler:null,processFilters:null}).service("bbDataMartReportService",["bbDataMartReportConfiguration","$sce","$window","$q","$timeout","bbHelp",function(b,c,d,e,f,g){function h(){return void 0===m&&(m=/iPad|iPod|iPhone/i.test(d.navigator.userAgent)),m}function i(){return b.api}function j(a,g){var j=i();j.maintainAuthentication(a).then(function(){function i(c,d,f,g){return e(function(h){var i=[j.getDataMartId(),j.getObjectUriFromIdentifier(c),j.getApiRoot()];d&&b.processFilters&&i.push(b.processFilters(d)),e.all(i).then(function(c){var e,i,j,k;e=c[0],i=c[1],k=c[2],c[3]&&(d=c[3]),e&&i&&k&&(j=f?"/dashboard.html?":"/reportWidget.html?",d&&angular.forEach(d,function(a,b){j+=encodeURIComponent(b)+"="+encodeURIComponent(a)+"&"}),j+="#project=/gdc/projects/",j+=e,j+=f?"&dashboard=":"&report=",j+=i,j+="&title=no&override=ui.frameinfo",b.linkHandler&&(j+=",ui.link"),g&&(j+=",ui.drill"),a.noChrome&&(j+="&nochrome=true"),j=f?k+"/labs/apps/dashboard_stylist/embed.html?width=100%25&src="+encodeURIComponent(j):k+j,h(j))})})}function k(){a.frameUrl=null,i(a.embeddedObjectId,a.filters,g,a.drillHandler||b.drillHandler).then(function(b){a.frameUrl=c.trustAsResourceUrl(b)})}function l(){a.frameUrl=null,f(function(){k()})}var m=angular.element(d),n=a.$id;a.$watch("embeddedObjectId",k),a.$watch("filters",k,!0),k(),h()&&m.on("orientationchange."+n,l),a.handleFrameEvent=function(c){"app.ok"===c.type&&"ui.frameinfo"===c.name?g&&c.data&&c.data.height&&(a.frameHeight=c.data.height+20+"px"):"app.event"===c.type&&("ui.drill"===c.name?a.drillHandler?a.drillHandler(c.data):b.drillHandler&&b.drillHandler(c.data):"ui.link"===c.name&&c.data&&c.data.uri&&b.linkHandler(c.data.uri))},a.$on("$destroy",function(){m.off("orientationchange."+n)})})}function k(a){var b=i();b.maintainAuthentication(a).then(function(){function d(){return e(function(a){var c=[b.getDataMartId(),b.getApiRoot()];e.all(c).then(function(b){var c,d,e;c=b[0],e=b[1],c&&e&&(d=e+"/analyze/embedded/#/",d+=c,d+="/reportId/edit",a(d))})})}function f(){a.frameUrl=null,d().then(function(b){a.frameUrl=c.trustAsResourceUrl(b)})}f()})}function l(b,c){function e(a){b.windowEventCallback(a)}b.windowEventCallback=function(d){var e;return c.find("iframe")[0]&&c.find("iframe")[0].contentWindow===d.source?(b.stylesInjected||d.source&&(b.stylesInjected=!0,d.source.postMessage(JSON.stringify(a),"*")),e=angular.isString(d.data)?JSON.parse(d.data):d.data,void(e.gdc&&(e=e.gdc,b.$apply(function(){b.handleFrameEvent(e)})))):void("https://www.blackbaud.com"===d.origin&&d.data.indexOf("bbHelpKey")>0&&(e=angular.isString(d.data)?JSON.parse(d.data):d.data,e.bbHelpKey&&g.open(e.bbHelpKey)))},d.addEventListener("message",e,!1),b.$on("$destroy",function(){d.removeEventListener("message",e,!1)})}var m;return{controller:["$scope",function(a){j(a,!1)}],reportController:["$scope",function(a){j(a,!1)}],dashboardController:["$scope",function(a){j(a,!0)}],responsiveDashboardController:["$scope","bbMediaBreakpoints",function(a,b){function c(b){a.breakPoints=b}b.register(c),a.$on("$destroy",function(){b.unregister(c)})}],designerController:["$scope",function(a){k(a)}],reportLink:l,dashboardLink:l}}]).directive("bbDataMartReport",["bbDataMartReportService",function(a){return{replace:!0,restrict:"E",templateUrl:"templates/datamartreport/embedtemplate.html",scope:{embeddedObjectId:"=bbDataMartReportId",filters:"=bbDataMartReportFilters",drillHandler:"=bbDataMartReportDrillHandler",frameHeight:"@height",frameWidth:"@width"},link:a.reportLink,controller:a.controller}}]).directive("bbDataMartDashboard",["bbDataMartReportService",function(a){return{replace:!0,restrict:"E",templateUrl:"templates/datamartreport/embedtemplate.html",scope:{embeddedObjectId:"=bbDataMartDashboardId",filters:"=bbDataMartDashboardFilters",drillHandler:"=bbDataMartDashboardDrillHandler",noChrome:"=bbDataMartDashboardNoChrome",frameWidth:"@width"},link:a.dashboardLink,controller:a.dashboardController}}]).directive("bbDataMartResponsiveDashboard",["bbDataMartReportService",function(a){return{replace:!0,restrict:"E",templateUrl:"templates/datamartreport/responsivedashboard.html",scope:{xsId:"=bbDataMartResponsiveDashboardXs",smId:"=bbDataMartResponsiveDashboardSm",lgId:"=bbDataMartResponsiveDashboardLg",drillHandler:"=bbDataMartResponsiveDashboardDrillHandler"},controller:a.responsiveDashboardController}}]).directive("bbDataMartDesigner",["bbDataMartReportService",function(a){return{replace:!0,restrict:"E",templateUrl:"templates/datamartreport/embedtemplate.html",scope:{frameHeight:"@height",frameWidth:"@width"},controller:a.designerController}}])}(),function(){"use strict";var a=["npi-datamart.authentication","npi-datamart.api","npi-datamart.report","npi-datamart.templates"];angular.module("npi-datamart",a)}(),angular.module("npi-datamart.templates",[]).run(["$templateCache",function(a){a.put("templates/datamartreport/embedtemplate.html",'<div>\n  <iframe height="{{frameHeight}}" width="{{frameWidth}}" ng-if="frameUrl" ng-src="{{frameUrl}}" frameborder="0" allowtransparency="false"></iframe>\n</div>\n'),a.put("templates/datamartreport/responsivedashboard.html",'<div style="text-align:center">\n  <div ng-if="breakPoints.xs">\n    <bb-data-mart-dashboard bb-data-mart-dashboard-drill-handler="drillHandler" bb-data-mart-dashboard-id="xsId" width="340px" bb-data-mart-dashboard-no-chrome="true"></bb-data-mart-dashboard>\n  </div>\n  <div ng-if="breakPoints.sm">\n    <bb-data-mart-dashboard bb-data-mart-dashboard-drill-handler="drillHandler" bb-data-mart-dashboard-id="smId" width="776px" bb-data-mart-dashboard-no-chrome="true"></bb-data-mart-dashboard>\n  </div>\n  <div ng-if="breakPoints.md">\n    <bb-data-mart-dashboard bb-data-mart-dashboard-drill-handler="drillHandler" bb-data-mart-dashboard-id="lgId" width="100%"  bb-data-mart-dashboard-no-chrome="true"></bb-data-mart-dashboard>\n  </div>\n  <div ng-if="breakPoints.lg">\n    <bb-data-mart-dashboard bb-data-mart-dashboard-drill-handler="drillHandler" bb-data-mart-dashboard-id="lgId" width="100%"></bb-data-mart-dashboard>\n  </div>\n</div>\n')}]);
//# sourceMappingURL=npi-datamart.min.js.map